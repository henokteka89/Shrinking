SHRINKING
--
--Change the following
  -- @logicalname - logical name of the file you wanted to shrink (data or log of a database)
  -- @Size to what size you want to shrink it to. For instance if you want to shrink the size to 200gb, put 200000. If you want to claim all the space, put 0. 
  -- Be in the database you want to shrink the size of 
--
Use DBname
Go

DECLARE @sql NVARCHAR(4000)
DECLARE @size INT
DECLARE @logicalname VARCHAR(100) = 'admin_log' -- Change

SET @size = ( 
SELECT size/128 * .99 -- AS CurrentSizeMB,
FROM sys.database_files
WHERE name = @logicalname
)
SELECT @size

WHILE @size > 700000
AND DatePart(Hour,Getdate()) < 21 --to stop at 9PM
BEGIN
   -- Print 'Start shrinking'
    SET @sql = 'DBCC SHRINKFILE (N''' + @logicalname + ''', ' + CAST(@size AS VARCHAR) + ')'

    PRINT @sql
    EXEC sys.sp_executesql @sql

   SET @size = ( 
SELECT size/128 * .99 -- AS CurrentSizeMB,
FROM sys.database_files
WHERE name = @logicalname
)
END


-- Monitor on a separate window

SELECT DISTINCT
       req.session_id,
       req.start_time,  
	   req.command,
       req.status, --req.cpu_time, req.total_elapsed_time,
       req.wait_time, req.wait_type,
       DB_NAME(isnull(rsc_dbid, req.database_id)) AS Dbname, --req.last_wait_type,
       req.percent_complete,
	   object_name(rsc_objid, rsc_dbid)  AS Tablename   
FROM sys.dm_exec_requests req
LEFT JOIN master.dbo.syslockinfo slf on req_spid = req.session_id and rsc_objid <> 0
LEFT JOIN sys.indexes ix on slf.rsc_objid = ix.object_id and slf.rsc_indid = ix.index_id
WHERE  req.command LIKE '%DBCC%' -- IN ('dbccfilescompact', dbccspacereclaim')

-- GET SPACE usage info and reason for not reusing log space

 -- Get log space size and used percentage
 Drop Table If Exists #loginfo
 Create table #loginfo (databasename nvarchar(128), logsizeMB real, logspaceusedpct real, status int)
 Insert into #loginfo (databasename, logsizeMB, logspaceusedpct, status)
 Exec ('dbcc sqlperf(logspace)') ;
 Select databasename, logsizeMB, cast(logspaceusedpct as decimal(10,2)) logspaceusedpct, status from #loginfo Order by logsizeMB Desc

 -- Log Reuse reason (not for releasing space) 
 Select name as DBname, recovery_model_desc, log_reuse_wait_desc [reason_for_not_releasing]
 From sys.databases where DB_NAME(database_id) = 'DBADashDB';
